#!/bin/bash

# –î–µ–ª–∞–µ–º –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
set -e

echo "–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ -d "venv" ]; then
    echo "–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    source venv/bin/activate
else
    echo "–°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    python3 -m venv venv
    source venv/bin/activate
fi

# 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
if [ -f "requirements.txt" ]; then
    echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip install --upgrade pip
    pip install -r requirements.txt
else
    echo "requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é."
fi

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ffmpeg
if ! command -v ffmpeg &> /dev/null; then
    echo "ffmpeg –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ffmpeg –¥–ª—è —Ä–∞–±–æ—Ç—ã –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π."
else
    echo "ffmpeg –Ω–∞–π–¥–µ–Ω."
fi

# ------------------------------
# 4. –ó–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞ OAuth
# ------------------------------
echo "üöÄ –ó–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..."
python3 oauth_server.py &

# –°–æ—Ö—Ä–∞–Ω—è–µ–º PID —Å–µ—Ä–≤–µ—Ä–∞
FLASK_PID=$!

# ------------------------------
# 5. –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞
# ------------------------------
echo "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
python3 telegram_calendar_bot.py

# ------------------------------
# 6. –ö–æ–≥–¥–∞ –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Flask —Å–µ—Ä–≤–µ—Ä
# ------------------------------
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Flask —Å–µ—Ä–≤–µ—Ä–∞..."
kill $FLASK_PID
